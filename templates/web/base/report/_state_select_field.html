<select class="form-control" name="state"  id="state">
[% IF include_empty %]
    <option value="">---</option>
[% END %]
[% SET found = 0 ~%]
[% FOREACH group IN state_groups ~%]
    [% FOREACH state IN group.1 ~%]
        [% SET found = 1 IF state == current_state ~%]
    [% END ~%]
[% END ~%]
[% IF NOT found ~%]
    <option selected value="[% current_state %]">[% current_state | prettify_state %]</option>
[% END ~%]
[% FOREACH group IN state_groups %]
    <optgroup label="[% group.0 %]">
    [% FOREACH state IN group.1 %]
        <option [% 'selected ' IF state == current_state %]value="[% state %]">[% state | prettify_state %]</option>
    [% END %]
    </optgroup>
[% END %]
</select>
